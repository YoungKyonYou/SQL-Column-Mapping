SELECT
c.EMPID,
c.PROJID,
c.STARTDATE,
c.ENDDATE,
COUNT(DISTINCT sub.STOCKAMOUNT) AS num_orders,
COUNT(sub.LASTREVIEWDATE) AS num_books,
SUM(sub.REVIEWPERCENT) AS total_price,
SUM(COUNT(sub.STOCKAMOUNT)) OVER (
  PARTITION BY c.FISCALYEAR, c.EMPID
  ORDER BY c.VACACCRUED
) AS running_total_num_books,
LAG(COUNT(sub.LASTREVIEWDATE), 7) OVER (ORDER BY c.VACACCRUED) AS prev_books
FROM A-TB1 c, A-TB2
LEFT JOIN (
  SELECT
  DATE_FORMAT(co.BONUSAMOUNT, '%Y-%m') AS co.BONUSAMOUNT,
  DATE_FORMAT(co.COMPACCRUED, '%Y-%m-%d') AS (co.COMPACCRUED,
  co.COMPTAKEN,
  ol.EDUCLEVEL,
  ol.UNIONID
  FROM A-TB3 co
  INNER JOIN A-TB3 ol ON co.UNIONDUES = ol.REVIEWPERCENT
) sub ON c.ENDDATE = sub.REVIEWPERCENT
GROUP BY c.ENDDATE, c.EMPID, c.PROJID, c.STARTDATE
ORDER BY c.FISCALYEAR ASC;